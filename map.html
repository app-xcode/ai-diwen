
<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <title>Lokasi</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        html,
        body {
            margin: 0;
            padding: 0;
            height: 100%;
            overflow: hidden;
        }

        #map {
            width: 100%;
            height: 100%;
            background: #f3f3f3;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            font-family: Arial, sans-serif;
            color: #333;
        }

        /* overlay loading */
        #loadingOverlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.85);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            flex-direction: column;
        }

        .spinner {
            width: 60px;
            height: 60px;
            border: 6px solid #ccc;
            border-top: 6px solid #007bff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        #loadingOverlay p {
            margin-top: 15px;
            font-size: 16px;
            color: #333;
        }
    </style>
</head>

<body> 
    <div id="map">
        <div>Klik untuk menampilkan map</div>
    </div>

    <!-- overlay loading -->
    <div id="loadingOverlay">
        <div class="spinner"></div>
        <p>Mengambil lokasi Anda...</p>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        let mapx, marker, circle, watchId;
        let firstUpdate = true;

        const iconMerah = L.icon({
            iconUrl: "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png",
            shadowUrl: "https://unpkg.com/leaflet@1.9.3/dist/images/marker-shadow.png",
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34],
            shadowSize: [41, 41],
        });

        function initMap() {
            document.getElementById("map").innerHTML = ""; // hapus text awal
            document.getElementById("loadingOverlay").style.display = "flex"; // tampilkan loading

            mapx = L.map("map").setView([-2, 118], 5); // default Indonesia

            L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
                minZoom: 5,
                maxZoom: 19,
                attribution: '&copy; BRImvitas'
            }).addTo(mapx);

            startWatch();
        }

        // kirim ke parent form (tlDPK12.php)
        function sendToParent(lat, lng, accuracy) {
            window.parent.postMessage({
                lat: lat,
                lng: lng,
                akurasi: accuracy
            }, "*");
        }

        function startWatch() {
            if ('geolocation' in navigator) {
                let options = {
                    enableHighAccuracy: true,
                    timeout: 30000, // 30 detik
                    maximumAge: 0
                };

                function successCallback(position) {
                    const {
                        latitude,
                        longitude,
                        accuracy
                    } = position.coords;
                    const latLng = L.latLng(latitude, longitude);

                    if (!marker) {
                        marker = L.marker(latLng, {
                            icon: iconMerah
                        }).addTo(mapx);
                        circle = L.circle(latLng, {
                            color: '#00bdff4f',
                            fillColor: '#00bdff52',
                            fillOpacity: 0.5,
                            radius: accuracy
                        }).addTo(mapx);

                        // sembunyikan loading setelah posisi pertama didapat
                        document.getElementById("loadingOverlay").style.display = "none";
                    } else {
                        marker.setLatLng(latLng);
                        circle.setLatLng(latLng);
                        circle.setRadius(accuracy);
                    }

                    if (firstUpdate) {
                        mapx.setView(latLng, 18);
                        firstUpdate = false;
                    }

                    getAddressFromCoords(latitude, longitude, accuracy);
                    sendToParent(latitude, longitude, accuracy);
                }

                function errorCallback(err) {
                    console.error("Error geolocation:", err);
                    document.getElementById("loadingOverlay").innerHTML = "<p style='color:red'>Gagal mengambil lokasi.</p>";
                }

                watchId = navigator.geolocation.watchPosition(successCallback, errorCallback, options);
            } else {
                console.log("Geolocation tidak tersedia di browser ini.");
                document.getElementById("loadingOverlay").innerHTML = "<p style='color:red'>Geolocation tidak tersedia.</p>";
            }
        }

        function getAddressFromCoords(lat, lng, acc) {
            const url = `https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lng}&format=json&accept-language=id`;

            fetch(url)
                .then(res => res.json())
                .then(data => {
                    let alamat = data?.display_name || "Alamat tidak ditemukan";
                    marker.bindPopup(`
                        <b>Lokasi Anda:</b><br>
                        Koordinat: ${lat.toFixed(6)}, ${lng.toFixed(6)}<br>
                        Akurasi: ${acc.toFixed(1)} meter<br>
                        Alamat: ${alamat}
                    `).openPopup();
                })
                .catch(err => console.error("Gagal mendapatkan alamat:", err));
        }

        // klik map untuk memulai tracking
        document.getElementById("map").addEventListener("click", function() {
            if (!mapx) {
                initMap();
            }
        });
    </script>
</body>

</html>
